#include "spider.h"

#define VRAM_LOC	0x1F000000
#define BOTTOM_FB0_LOC	(void*)(VRAM_LOC + 0x0048F000)
#define BOTTOM_FB1_LOC	(void*)(VRAM_LOC + 0x004C7800)
#define MEM_STRIPE_SIZE 16
#define BYTES_PER_PIXEL	3
#define CHAR_WIDTH	8
#define CHAR_HEIGHT	8
#define BOTTOM_X_RES	320
#define BOTTOM_Y_RES	240
#define BOTTOM_FB_SIZE	BOTTOM_X_RES * BOTTOM_Y_RES * BYTES_PER_PIXEL
#define BOTTOM_COLS	BOTTOM_X_RES / CHAR_WIDTH
#define BOTTOM_ROWS	BOTTOM_Y_RES / CHAR_HEIGHT
#define BUFFER_LOC	(void*)0x18410000
#define BUFFER_SIZE	BOTTOM_FB_SIZE
#define FONT_START	32
#define COLOR_FG_DEF	0x00FFFFFF
#define COLOR_BG_DEF	0x00000000
#define COLOR_TRANS	0xFF000000

unsigned char font[] = {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x30,0x78,0x78,0x30,0x30,0x00,0x30,0x00,0x6C,0x6C,0x6C,0x00,0x00,0x00,0x00,0x00,0x6C,0x6C,0xFE,0x6C,0xFE,0x6C,0x6C,0x00,0x30,0x7C,0xC0,0x78,0x0C,0xF8,0x30,0x00,0x00,0xC6,0xCC,0x18,0x30,0x66,0xC6,0x00,0x38,0x6C,0x38,0x76,0xDC,0xCC,0x76,0x00,0x60,0x60,0xC0,0x00,0x00,0x00,0x00,0x00,0x18,0x30,0x60,0x60,0x60,0x30,0x18,0x00,0x60,0x30,0x18,0x18,0x18,0x30,0x60,0x00,0x00,0x66,0x3C,0xFF,0x3C,0x66,0x00,0x00,0x00,0x30,0x30,0xFC,0x30,0x30,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x30,0x30,0x60,0x00,0x00,0x00,0xFC,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x30,0x30,0x00,0x06,0x0C,0x18,0x30,0x60,0xC0,0x80,0x00,0x7C,0xC6,0xCE,0xDE,0xF6,0xE6,0x7C,0x00,0x30,0x70,0x30,0x30,0x30,0x30,0xFC,0x00,0x78,0xCC,0x0C,0x38,0x60,0xCC,0xFC,0x00,0x78,0xCC,0x0C,0x38,0x0C,0xCC,0x78,0x00,0x1C,0x3C,0x6C,0xCC,0xFE,0x0C,0x1E,0x00,0xFC,0xC0,0xF8,0x0C,0x0C,0xCC,0x78,0x00,0x38,0x60,0xC0,0xF8,0xCC,0xCC,0x78,0x00,0xFC,0xCC,0x0C,0x18,0x30,0x30,0x30,0x00,0x78,0xCC,0xCC,0x78,0xCC,0xCC,0x78,0x00,0x78,0xCC,0xCC,0x7C,0x0C,0x18,0x70,0x00,0x00,0x30,0x30,0x00,0x00,0x30,0x30,0x00,0x00,0x30,0x30,0x00,0x00,0x30,0x30,0x60,0x18,0x30,0x60,0xC0,0x60,0x30,0x18,0x00,0x00,0x00,0xFC,0x00,0x00,0xFC,0x00,0x00,0x60,0x30,0x18,0x0C,0x18,0x30,0x60,0x00,0x78,0xCC,0x0C,0x18,0x30,0x00,0x30,0x00,0x7C,0xC6,0xDE,0xDE,0xDE,0xC0,0x78,0x00,0x30,0x78,0xCC,0xCC,0xFC,0xCC,0xCC,0x00,0xFC,0x66,0x66,0x7C,0x66,0x66,0xFC,0x00,0x3C,0x66,0xC0,0xC0,0xC0,0x66,0x3C,0x00,0xF8,0x6C,0x66,0x66,0x66,0x6C,0xF8,0x00,0xFE,0x62,0x68,0x78,0x68,0x62,0xFE,0x00,0xFE,0x62,0x68,0x78,0x68,0x60,0xF0,0x00,0x3C,0x66,0xC0,0xC0,0xCE,0x66,0x3E,0x00,0xCC,0xCC,0xCC,0xFC,0xCC,0xCC,0xCC,0x00,0x78,0x30,0x30,0x30,0x30,0x30,0x78,0x00,0x1E,0x0C,0x0C,0x0C,0xCC,0xCC,0x78,0x00,0xE6,0x66,0x6C,0x78,0x6C,0x66,0xE6,0x00,0xF0,0x60,0x60,0x60,0x62,0x66,0xFE,0x00,0xC6,0xEE,0xFE,0xFE,0xD6,0xC6,0xC6,0x00,0xC6,0xE6,0xF6,0xDE,0xCE,0xC6,0xC6,0x00,0x38,0x6C,0xC6,0xC6,0xC6,0x6C,0x38,0x00,0xFC,0x66,0x66,0x7C,0x60,0x60,0xF0,0x00,0x78,0xCC,0xCC,0xCC,0xDC,0x78,0x1C,0x00,0xFC,0x66,0x66,0x7C,0x6C,0x66,0xE6,0x00,0x78,0xCC,0xE0,0x70,0x1C,0xCC,0x78,0x00,0xFC,0xB4,0x30,0x30,0x30,0x30,0x78,0x00,0xCC,0xCC,0xCC,0xCC,0xCC,0xCC,0xFC,0x00,0xCC,0xCC,0xCC,0xCC,0xCC,0x78,0x30,0x00,0xC6,0xC6,0xC6,0xD6,0xFE,0xEE,0xC6,0x00,0xC6,0xC6,0x6C,0x38,0x38,0x6C,0xC6,0x00,0xCC,0xCC,0xCC,0x78,0x30,0x30,0x78,0x00,0xFE,0xC6,0x8C,0x18,0x32,0x66,0xFE,0x00,0x78,0x60,0x60,0x60,0x60,0x60,0x78,0x00,0xC0,0x60,0x30,0x18,0x0C,0x06,0x02,0x00,0x78,0x18,0x18,0x18,0x18,0x18,0x78,0x00,0x10,0x38,0x6C,0xC6,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0x30,0x30,0x18,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x78,0x0C,0x7C,0xCC,0x76,0x00,0xE0,0x60,0x60,0x7C,0x66,0x66,0xDC,0x00,0x00,0x00,0x78,0xCC,0xC0,0xCC,0x78,0x00,0x1C,0x0C,0x0C,0x7C,0xCC,0xCC,0x76,0x00,0x00,0x00,0x78,0xCC,0xFC,0xC0,0x78,0x00,0x38,0x6C,0x60,0xF0,0x60,0x60,0xF0,0x00,0x00,0x00,0x76,0xCC,0xCC,0x7C,0x0C,0xF8,0xE0,0x60,0x6C,0x76,0x66,0x66,0xE6,0x00,0x30,0x00,0x70,0x30,0x30,0x30,0x78,0x00,0x0C,0x00,0x0C,0x0C,0x0C,0xCC,0xCC,0x78,0xE0,0x60,0x66,0x6C,0x78,0x6C,0xE6,0x00,0x70,0x30,0x30,0x30,0x30,0x30,0x78,0x00,0x00,0x00,0xCC,0xFE,0xFE,0xD6,0xC6,0x00,0x00,0x00,0xF8,0xCC,0xCC,0xCC,0xCC,0x00,0x00,0x00,0x78,0xCC,0xCC,0xCC,0x78,0x00,0x00,0x00,0xDC,0x66,0x66,0x7C,0x60,0xF0,0x00,0x00,0x76,0xCC,0xCC,0x7C,0x0C,0x1E,0x00,0x00,0xDC,0x76,0x66,0x60,0xF0,0x00,0x00,0x00,0x7C,0xC0,0x78,0x0C,0xF8,0x00,0x10,0x30,0x7C,0x30,0x30,0x34,0x18,0x00,0x00,0x00,0xCC,0xCC,0xCC,0xCC,0x76,0x00,0x00,0x00,0xCC,0xCC,0xCC,0x78,0x30,0x00,0x00,0x00,0xC6,0xD6,0xFE,0xFE,0x6C,0x00,0x00,0x00,0xC6,0x6C,0x38,0x6C,0xC6,0x00,0x00,0x00,0xCC,0xCC,0xCC,0x7C,0x0C,0xF8,0x00,0x00,0xFC,0x98,0x30,0x64,0xFC,0x00,0x1C,0x30,0x30,0xE0,0x30,0x30,0x1C,0x00,0x18,0x18,0x18,0x00,0x18,0x18,0x18,0x00,0xE0,0x30,0x30,0x1C,0x30,0x30,0xE0,0x00,0x76,0xDC,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x38,0x6C,0xC6,0xC6,0xFE,0x00};

unsigned *buf = (unsigned *)0x18411000;
unsigned char *bufc = (unsigned char*)0x18411000;

unsigned col = 0, row = 0;

void CopyMem(void *src, void *dst, unsigned size){ 
	GSPGPU_FlushDataCache(src, size); 
	GX_SetTextureCopy(src, dst, size, 0, 0, 0, 0, 8); 
	GSPGPU_FlushDataCache(dst, size); 
	svcSleepThread(0x200000LL); 
}

void WriteFB(void *buf, unsigned offset, unsigned size){
	CopyMem(buf, (void*)(BOTTOM_FB0_LOC + offset), size);
	CopyMem(buf, (void*)(BOTTOM_FB1_LOC + offset), size);
}

void ReadFB(void *buf, unsigned offset, unsigned size){
	CopyMem((void*)(BOTTOM_FB0_LOC + offset), buf, size);
}

void clearscreen(unsigned color){
	unsigned offs;
}

void print(char *value, unsigned fgcolor, unsigned bgcolor){
	unsigned pos = 0, offs, fontoffs, x, y, color;
	unsigned char c;
	while((c = value[pos++]) != 0){
		if(col >= BOTTOM_COLS){
			col = 0;
			row++;
		}
		switch(c){
			case "\b":
				if(col == 0){
					col = BOTTOM_COLS;
					row--;
				}
				col--;
				break;
			case "\t":
				col += 8;
				break;
			case "\n":
				row++;
				break;
			case "\v":
				row += 6;
				break;
			case "\f":
				col = 0;
				row = 0;
				color = bgcolor;
				for(offs = 0; offs < MEM_STRIPE_SIZE * BYTES_PER_PIXEL >> 2; offs++){
					color &= color << 24;
					buf[offs] = color;
					color >>= 8;
				}
				for(offs = 0; offs < BOTTOM_FB_SIZE; offs += MEM_STRIPE_SIZE * BYTES_PER_PIXEL){
					WriteFB(buf, offs, MEM_STRIPE_SIZE * BYTES_PER_PIXEL);
				}
				break;
			case "\r":
				col = 0;
				break;
			default:
				if(c >= FONT_START){
					fontoffs = c - FONT_START << 3;
					ReadFB( buf, offset?, BOTTOM_Y_RES * CHAR_WIDTH * BYTES_PER_PIXEL );

					offs = ((BOTTOM_ROWS - row) * CHAR_HEIGHT - 1 + col * BOTTOM_Y_RES * CHAR_WIDTH) * BYTES_PER_PIXEL;
					for(y = 0; y < CHAR_HEIGHT; y++){
						c = font[fontoffs++];
						for(x = 0; x < BOTTOM_Y_RES * BYTES_PER_PIXEL * CHAR_WIDTH; x++){
							if(~(color = c & 0x80 ? fgcolor : bgcolor) & COLOR_TRANS){
								bufc[offs] = color & 0xFF;
								color >>= 8;
								bufc[offs+1] = color & 0xFF;
								color >>= 8;
								bufc[offs+2] = color & 0xFF;
							}
							c <<= 1;
							offs += BOTTOM_Y_RES * BYTES_PER_PIXEL;
						}
						offs -= BOTTOM_Y_RES * CHAR_WIDTH * BYTES_PER_PIXEL + BYTES_PER_PIXEL;
					}
					WriteFB( buf, offset, BOTTOM_Y_RES * CHAR_WIDTH * BYTES_PER_PIXEL );
					col++;
				}
				break;
		}
	}
}

void print(char *value){
	print(value, COLOR_FG_DEF, COLOR_BG_DEF)
}

void print(unsigned value, unsigned fgcolor, unsigned bgcolor){
	char c, itoa[11];
	itoa = "0x";
	for(unsigned i = 0; i < 8; i++){
		c = value >> 28 - (i << 2) & 0x0F;
		itoa[i + 2] = c + (c > 9 ? 0x37 : 0x30);
	}
	itoa[10] = 0;
	print(&itoa, fgcolor, bgcolor);
}

void print(unsigned value){
	print(value, COLOR_FG_DEF, COLOR_BG_DEF);
}

int uvl_entry()
{
	print("\vtest string\r\n\t");
	print(0xDEADBEEF, 0x00FF7F00, COLOR_TRANS);
}
